{% extends "base.html" %}

{% block content %}
<h2>เพิ่มสินค้าใหม่</h2>

{% if error %}
<div class="alert alert-danger">
    {{ error }}
</div>
{% endif %}

<form method="POST">
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">ชื่อสินค้า</label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">บาร์โค้ด</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="barcode" name="barcode" required>
                    <button type="button" class="btn btn-outline-secondary" onclick="startBarcodeScanner()">
                        <i class="fas fa-camera"></i> สแกน
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">หน่วย</label>
                <input type="text" class="form-control" id="unit" name="unit" required>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">สต๊อกขั้นต่ำ</label>
                <input type="number" class="form-control" id="min_stock" name="min_stock" value="0" required>
            </div>
        </div>
    </div>
    
    <div class="mb-3">
        <label class="form-label">รายละเอียดสินค้า</label>
        <textarea class="form-control" name="description" rows="3" placeholder="รายละเอียดสินค้า"></textarea>
    </div>
    
    <div class="mb-3">
        <label class="form-label">รูปภาพสินค้า</label>
        <div class="input-group">
            <input type="file" class="form-control" id="image" name="image" accept="image/*">
            <button type="button" class="btn btn-outline-secondary" onclick="startCamera()">
                <i class="fas fa-camera"></i> ถ่ายรูป
            </button>
        </div>
        <div class="form-text">อัปโหลดไฟล์หรือถ่ายรูปจากกล้อง</div>
        <img id="image-preview" style="display:none; width:100px; height:100px; object-fit:cover; border-radius:8px; margin-top:10px;">
    </div>
    
    <div class="mb-3">
        <input type="submit" class="btn btn-primary" value="บันทึก">
        <a href="{{ url_for('products') }}" class="btn btn-secondary">ยกเลิก</a>
    </div>
</form>

<div id="scanner-modal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">สแกนบาร์โค้ด</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <video id="scanner-video" width="100%" style="border-radius: 8px;"></video>
                <div class="mt-2">
                    <small class="text-muted">จัดกล้องให้เห็นบาร์โค้ดในกรอบสี่เหลี่ยม</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="camera-modal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ถ่ายรูปสินค้า</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <video id="camera-video" width="100%" autoplay></video>
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="capturePhoto()">
                        <i class="fas fa-camera"></i> ถ่ายรูป
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('productForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const data = {
        name: document.getElementById('name').value,
        barcode: document.getElementById('barcode').value,
        unit: document.getElementById('unit').value,
        min_stock: parseInt(document.getElementById('min_stock').value)
    };
    
    try {
        const response = await fetch('/add_product', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('เพิ่มสินค้าสำเร็จ');
            window.location.href = '/products';
        }
    } catch (error) {
        alert('เกิดข้อผิดพลาด');
    }
});
</script>
{% endblock %}